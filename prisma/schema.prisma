generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum OrganizationRole {
  OWNER
  ADMIN
  MEMBER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum AuditEntityType {
  PROJECT
  TASK
  COMMENT
  TAG
  ORGANIZATION
  USER
}

enum AuditAction {
  CREATED
  UPDATED
  DELETED
  STATUS_CHANGED
  MEMBER_INVITED
  MEMBER_JOINED
  ATTACHED
  DETACHED
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())

  organizations UserOrganization[]
  assignedTasks Task[]
  comments      Comment[]
  auditLogs     AuditLog[]
  refreshTokens RefreshToken[]
}

model Organization {
  id        Int      @id @default(autoincrement())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())

  users       UserOrganization[]
  projects    Project[]
  invitations Invitation[]
  tags        Tag[]
}

model Project {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  createdAt   DateTime @default(now())

  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  tasks Task[]

  @@index([organizationId])
  @@index([createdAt])
}

model Task {
  id          Int        @id @default(autoincrement())
  title       String
  description String?
  status      TaskStatus @default(TODO)
  createdAt   DateTime   @default(now())

  projectId Int
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  assigneeId Int?
  assignee   User? @relation(fields: [assigneeId], references: [id])

  comments Comment[]
  tags     TaskTag[]

  @@index([projectId])
  @@index([status])
  @@index([createdAt])
  @@index([assigneeId])
}

model Comment {
  id        Int      @id @default(autoincrement())
  content   String
  createdAt DateTime @default(now())

  taskId Int
  task   Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  authorId Int
  author   User @relation(fields: [authorId], references: [id])
}

model AuditLog {
  id Int @id @default(autoincrement())

  userId Int
  user   User @relation(fields: [userId], references: [id])

  action     AuditAction
  entityType AuditEntityType
  entityId   Int

  metadata Json

  createdAt DateTime @default(now())

  @@index([entityId])
  @@index([createdAt])
  @@index([userId])
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  userId Int
  user   User @relation(fields: [userId], references: [id])
}

model Invitation {
  id             Int              @id @default(autoincrement())
  email          String
  organizationId Int
  role           OrganizationRole
  status         InvitationStatus @default(PENDING)
  token          String           @unique
  expiresAt      DateTime
  createdAt      DateTime         @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model UserOrganization {
  userId         Int
  organizationId Int
  role           OrganizationRole

  user         User         @relation(fields: [userId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  @@id([userId, organizationId])
}

model Tag {
  id   Int    @id @default(autoincrement())
  name String @unique

  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  tasks TaskTag[]

  @@unique([name, organizationId])
}

model TaskTag {
  taskId    Int
  tagId     Int
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id])
  tag  Tag  @relation(fields: [tagId], references: [id])

  @@id([taskId, tagId])
}
